<?xml version="1.0" encoding="UTF-8"?>
<!--
  REFERENCE: Mirth Connect channel config for HL7 â†’ Dialysis PDMS.

  This is a simplified reference. Mirth's full export format is more complex.
  Create the channel manually per docs/mirth/README.md, or use Mirth's Export
  feature to get a proper importable XML.

  Key settings:
  - Source: TCP Listener on port 6661, HL7 encoding
  - Destination: HTTP Sender POST to http://localhost:5000/api/v1/hl7/stream
  - Content-Type: application/json
  - Header: X-Tenant-Id: default
  - Transformer: Build { "rawMessage": raw } from messageObject.getRawData()
-->
<channel version="4.3.0">
  <id>hl7-to-dialysis-pdms</id>
  <name>HL7 to Dialysis PDMS</name>
  <description>Receives HL7 ORU/ADT and forwards to Dialysis PDMS REST API</description>
  <revision>1</revision>
  <sourceConnector version="4.3.0">
    <metaDataId>0</metaDataId>
    <name>HL7 Listener</name>
    <properties class="com.mirth.connect.connectors.tcp.TcpReceiverProperties">
      <pluginProperties/>
      <listenerConnectorProperties version="4.3.0">
        <port>6661</port>
        <receiveTimeout>0</receiveTimeout>
        <receiveBufferSize>0</receiveBufferSize>
        <charsetEncoding>DEFAULT_ENCODING</charsetEncoding>
      </listenerConnectorProperties>
    </properties>
    <transformer version="4.3.0">
      <elements/>
      <inboundDataType>HL7V2</inboundDataType>
      <outboundDataType>HL7V2</outboundDataType>
      <inboundProperties class="com.mirth.connect.plugins.datatypes.hl7v2.HL7v2DataTypeProperties">
        <serializationProperties class="com.mirth.connect.plugins.datatypes.hl7v2.HL7v2SerializationProperties"/>
        <deserializationProperties class="com.mirth.connect.plugins.datatypes.hl7v2.HL7v2DeserializationProperties"/>
        <batchProperties class="com.mirth.connect.plugins.datatypes.hl7v2.HL7v2BatchProperties"/>
        <responseGenerationProperties class="com.mirth.connect.plugins.datatypes.hl7v2.HL7v2ResponseGenerationProperties"/>
        <responseValidationProperties class="com.mirth.connect.plugins.datatypes.hl7v2.HL7v2ResponseValidationProperties"/>
      </inboundProperties>
      <outboundProperties class="com.mirth.connect.plugins.datatypes.hl7v2.HL7v2DataTypeProperties">
        <serializationProperties class="com.mirth.connect.plugins.datatypes.hl7v2.HL7v2SerializationProperties"/>
        <deserializationProperties class="com.mirth.connect.plugins.datatypes.hl7v2.HL7v2DeserializationProperties"/>
        <batchProperties class="com.mirth.connect.plugins.datatypes.hl7v2.HL7v2BatchProperties"/>
        <responseGenerationProperties class="com.mirth.connect.plugins.datatypes.hl7v2.HL7v2ResponseGenerationProperties"/>
        <responseValidationProperties class="com.mirth.connect.plugins.datatypes.hl7v2.HL7v2ResponseValidationProperties"/>
      </outboundProperties>
    </transformer>
  </sourceConnector>
  <destinationConnectors>
    <connector version="4.3.0">
      <metaDataId>1</metaDataId>
      <name>PDMS HTTP</name>
      <properties class="com.mirth.connect.connectors.http.HttpDispatcherProperties">
        <pluginProperties/>
        <destinationConnectorProperties version="4.3.0">
          <queueEnabled>false</queueEnabled>
          <sendFirst>true</sendFirst>
          <retryIntervalMillis>10000</retryIntervalMillis>
          <invalidateMetaDataCache>false</invalidateMetaDataCache>
          <queueBufferSize>1000</queueBufferSize>
        </destinationConnectorProperties>
        <host>localhost:5000</host>
        <useHttps>false</useHttps>
        <method>POST</method>
        <contentType>application/json</contentType>
        <path>/api/v1/hl7/stream</path>
        <headers class="linked-hash-map">
          <entry>
            <string>X-Tenant-Id</string>
            <string>default</string>
          </entry>
        </headers>
      </properties>
      <transformer version="4.3.0">
        <elements>
          <element>
            <name>Build JSON for PDMS</name>
            <sequenceNumber>0</sequenceNumber>
            <enabled>true</enabled>
            <script>
// Raw HL7 message
var raw = messageObject.getRawData();

// PDMS expects: { "rawMessage": "MSH|..." }
var payload = {
  rawMessage: raw
};

channelMap.put('requestBody', JSON.stringify(payload));
return JSON.stringify(payload);
            </script>
          </element>
        </elements>
        <inboundDataType>HL7V2</inboundDataType>
        <outboundDataType>JSON</outboundDataType>
      </transformer>
    </connector>
  </destinationConnectors>
</channel>

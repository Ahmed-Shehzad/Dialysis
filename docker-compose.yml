# Dialysis PDMS – full solution run
# Usage: docker compose up -d
# Gateway: http://localhost:5001 | Health: http://localhost:5001/health
# (Host port 5001 avoids conflict with other services using 5000)
# APIs: Patient 5051, Prescription 5052, Treatment 5050, Alarm 5053, Device 5054
#       Fhir 5055, CDS 5056, Reports 5057
# Mirth (optional): docker compose --profile mirth up -d  → Admin http://localhost:9080, MLLP 6661

services:
  redis:
    image: redis:7-alpine
    ports:
      - "6379:6379"
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 5s
      timeout: 3s
      retries: 3

  postgres:
    image: postgres:16-alpine
    environment:
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: postgres
      POSTGRES_DB: postgres
    volumes:
      - postgres_data:/var/lib/postgresql/data
      - ./docker/postgres/init:/docker-entrypoint-initdb.d:ro
    ports:
      - "5432:5432"
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres"]
      interval: 5s
      timeout: 5s
      retries: 5

  patient-api:
    build:
      context: .
      dockerfile: Dockerfile
      args:
        PROJECT_PATH: Services/Dialysis.Patient/Dialysis.Patient.Api/Dialysis.Patient.Api.csproj
    command: ["Dialysis.Patient.Api.dll"]
    environment:
      ASPNETCORE_ENVIRONMENT: Development
      ASPNETCORE_URLS: http://+:5051
      ConnectionStrings__PatientDb: Host=postgres;Database=dialysis_patient;Username=postgres;Password=postgres
    ports:
      - "5051:5051"
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:5051/health"]
      interval: 10s
      timeout: 5s
      retries: 3
      start_period: 10s
    depends_on:
      postgres:
        condition: service_healthy

  prescription-api:
    build:
      context: .
      dockerfile: Dockerfile
      args:
        PROJECT_PATH: Services/Dialysis.Prescription/Dialysis.Prescription.Api/Dialysis.Prescription.Api.csproj
    command: ["Dialysis.Prescription.Api.dll"]
    environment:
      ASPNETCORE_ENVIRONMENT: Development
      ASPNETCORE_URLS: http://+:5052
      ConnectionStrings__PrescriptionDb: Host=postgres;Database=dialysis_prescription;Username=postgres;Password=postgres
      ConnectionStrings__Redis: redis:6379
    ports:
      - "5052:5052"
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:5052/health"]
      interval: 10s
      timeout: 5s
      retries: 3
      start_period: 10s
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy

  treatment-api:
    build:
      context: .
      dockerfile: Dockerfile
      args:
        PROJECT_PATH: Services/Dialysis.Treatment/Dialysis.Treatment.Api/Dialysis.Treatment.Api.csproj
    command: ["Dialysis.Treatment.Api.dll"]
    environment:
      ASPNETCORE_ENVIRONMENT: Development
      ASPNETCORE_URLS: http://+:5050
      ConnectionStrings__TreatmentDb: Host=postgres;Database=dialysis_treatment;Username=postgres;Password=postgres
      ConnectionStrings__TransponderDb: Host=postgres;Database=transponder;Username=postgres;Password=postgres
      DeviceApi__BaseUrl: http://device-api:5054
      AlarmApi__BaseUrl: http://alarm-api:5053
      FhirSubscription__NotifyUrl: http://gateway:5000
    ports:
      - "5050:5050"
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:5050/health"]
      interval: 10s
      timeout: 5s
      retries: 3
      start_period: 10s
    depends_on:
      postgres:
        condition: service_healthy

  alarm-api:
    build:
      context: .
      dockerfile: Dockerfile
      args:
        PROJECT_PATH: Services/Dialysis.Alarm/Dialysis.Alarm.Api/Dialysis.Alarm.Api.csproj
    command: ["Dialysis.Alarm.Api.dll"]
    environment:
      ASPNETCORE_ENVIRONMENT: Development
      ASPNETCORE_URLS: http://+:5053
      ConnectionStrings__AlarmDb: Host=postgres;Database=dialysis_alarm;Username=postgres;Password=postgres
      ConnectionStrings__TransponderDb: Host=postgres;Database=transponder;Username=postgres;Password=postgres
      DeviceApi__BaseUrl: http://device-api:5054
      FhirSubscription__NotifyUrl: http://gateway:5000
    ports:
      - "5053:5053"
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:5053/health"]
      interval: 10s
      timeout: 5s
      retries: 3
      start_period: 10s
    depends_on:
      postgres:
        condition: service_healthy

  device-api:
    build:
      context: .
      dockerfile: Dockerfile
      args:
        PROJECT_PATH: Services/Dialysis.Device/Dialysis.Device.Api/Dialysis.Device.Api.csproj
    command: ["Dialysis.Device.Api.dll"]
    environment:
      ASPNETCORE_ENVIRONMENT: Development
      ASPNETCORE_URLS: http://+:5054
      ConnectionStrings__DeviceDb: Host=postgres;Database=dialysis_device;Username=postgres;Password=postgres
    ports:
      - "5054:5054"
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:5054/health"]
      interval: 10s
      timeout: 5s
      retries: 3
      start_period: 10s
    depends_on:
      postgres:
        condition: service_healthy

  fhir-api:
    build:
      context: .
      dockerfile: Dockerfile
      args:
        PROJECT_PATH: Services/Dialysis.Fhir/Dialysis.Fhir.Api/Dialysis.Fhir.Api.csproj
    command: ["Dialysis.Fhir.Api.dll"]
    environment:
      ASPNETCORE_ENVIRONMENT: Development
      ASPNETCORE_URLS: http://+:5055
      ConnectionStrings__FhirDb: Host=postgres;Database=dialysis_fhir;Username=postgres;Password=postgres
      FhirExport__BaseUrl: http://gateway:5000
    ports:
      - "5055:5055"
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:5055/health"]
      interval: 10s
      timeout: 5s
      retries: 3
      start_period: 10s
    depends_on:
      postgres:
        condition: service_healthy

  cds-api:
    build:
      context: .
      dockerfile: Dockerfile
      args:
        PROJECT_PATH: Services/Dialysis.Cds/Dialysis.Cds.Api/Dialysis.Cds.Api.csproj
    command: ["Dialysis.Cds.Api.dll"]
    environment:
      ASPNETCORE_ENVIRONMENT: Development
      ASPNETCORE_URLS: http://+:5056
      Cds__BaseUrl: http://gateway:5000
    ports:
      - "5056:5056"
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:5056/health"]
      interval: 10s
      timeout: 5s
      retries: 3
      start_period: 10s

  reports-api:
    build:
      context: .
      dockerfile: Dockerfile
      args:
        PROJECT_PATH: Services/Dialysis.Reports/Dialysis.Reports.Api/Dialysis.Reports.Api.csproj
    command: ["Dialysis.Reports.Api.dll"]
    environment:
      ASPNETCORE_ENVIRONMENT: Development
      ASPNETCORE_URLS: http://+:5057
      Reports__BaseUrl: http://gateway:5000
    ports:
      - "5057:5057"
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:5057/health"]
      interval: 10s
      timeout: 5s
      retries: 3
      start_period: 10s

  gateway:
    build:
      context: .
      dockerfile: Dockerfile
      args:
        PROJECT_PATH: Gateway/Dialysis.Gateway/Dialysis.Gateway.csproj
    command: ["Dialysis.Gateway.dll"]
    environment:
      ASPNETCORE_URLS: http://0.0.0.0:5000
      ReverseProxy__Clusters__patient-cluster__Destinations__patient__Address: http://patient-api:5051
      ReverseProxy__Clusters__prescription-cluster__Destinations__prescription__Address: http://prescription-api:5052
      ReverseProxy__Clusters__treatment-cluster__Destinations__treatment__Address: http://treatment-api:5050
      ReverseProxy__Clusters__alarm-cluster__Destinations__alarm__Address: http://alarm-api:5053
      ReverseProxy__Clusters__device-cluster__Destinations__device__Address: http://device-api:5054
      ReverseProxy__Clusters__fhir-cluster__Destinations__fhir__Address: http://fhir-api:5055
      ReverseProxy__Clusters__cds-cluster__Destinations__cds__Address: http://cds-api:5056
      ReverseProxy__Clusters__reports-cluster__Destinations__reports__Address: http://reports-api:5057
    ports:
      - "5001:5000"
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:5000/health"]
      interval: 10s
      timeout: 5s
      retries: 3
      start_period: 15s
    depends_on:
      patient-api:
        condition: service_healthy
      prescription-api:
        condition: service_healthy
      treatment-api:
        condition: service_healthy
      alarm-api:
        condition: service_healthy
      device-api:
        condition: service_healthy
      fhir-api:
        condition: service_healthy
      cds-api:
        condition: service_healthy
      reports-api:
        condition: service_healthy

  mirth:
    image: nextgenhealthcare/connect:4.5
    profiles:
      - mirth
    ports:
      - "9080:8080"   # Admin UI (avoid conflict with other apps on 8080)
      - "6661:6661"   # MLLP listener
    environment:
      # PDMS Gateway URL for HTTP destinations (Mirth channels post to gateway)
      PDMS_GATEWAY_URL: http://gateway:5000
    depends_on:
      gateway:
        condition: service_started

volumes:
  postgres_data:
